Namespaces:
  =: io.murano.resources
  std: io.murano
  sys: io.murano.system


Name: AWSInstance

Extends: Instance

Properties:
  name:
    Contract: $.string().notNull()
  image:
    Contract: $.string().notNull()
  agent:
    Contract: $.class(sys:SSHAgent)
    Usage: Runtime
  ipAddresses:
    Contract: [$.string()]
    Usage: Out
  assignFloatingIp:
    Contract: $.bool().notNull()
    Default: false
  floatingIpAddress:
    Contract: $.string()
    Usage: Out
  flavor:
    Contract: $.string().notNull()
  securityGroupName:
    Contract: $.string().notNull()


Methods:
  initialize:
    Body:
      - $.environment: $.find(std:Environment).require()
      - $.resources: new(sys:Resources)
      - $.instanceTemplate: {}
      - $._floatingIpOutputName: null
      - $.node: null

  deploy:
    Arguments:
      plan:
        Contract: {}
    Body:
      - $securityGroupName: coalesce(
            $.securityGroupName,
            $.environment.securityGroupManager.defaultGroupName
          )
      - $.createDefaultInstanceSecurityGroupRules($securityGroupName)
      - If: $.cloudid != null
        Then:
           - $cloudid: $.cloudid
        Else:
           - $cloudid: $.environment.defaultCloud
      - $.cloud: new(sys:Cloud, cloudid => $cloudid)
      - $.agent: new(sys:SSHAgent, host => $,cloud=>$.cloud)
      - $.driver: new(sys:AWSBinding,cloud => $.cloud.getCredentials())
      - $.node: $.driver.createnode($.image,$.flavor,$.name,$.securityGroupName)
      - $.ipAddresses: $.driver.getpublicips($.node)
      - $.agent.setnode($.node)
  destroy:
    Body:
      - $.driver: new(sys:AWSBinding)
      - $.driver.destroynode($.node)
      - $.node: null

  createDefaultInstanceSecurityGroupRules:
    Arguments:
      - groupName:
          Contract: $.string().notNull()
